<!DOCTYPE html>
<html>
<head>
	<title>CRC 과제 안전지수 계산</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<style>
        canvas {
            padding-left: 0;
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
        }
		form {
			max-width: 600px;
			margin: 0 auto;
			text-align: left;
		}
		label {
			display: block;
			margin-bottom: 10px;
		}
		input {
			display: block;
			width: 100%;
			padding: 10px;
			border: 1px solid #ccc;
			border-radius: 4px;
			box-sizing: border-box;
			margin-bottom: 20px;
		}
		button {
			background-color: #4CAF50;
			color: white;
			padding: 10px 20px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
		}
        .hr {
			border-top: 1px solid #ccc;
			margin: 20px 0;
		}
        .container1 {
            display: flex;
            justify-content: center; 
            justify-content: space-around;
            
        }
        .container2 {
            display: flex;
            justify-content: center; 
            justify-content: space-around;
            
        }
        .container3 {
            display: flex;
            justify-content: center; 
            justify-content: space-around;
            
        }
        
	</style>
	<script>
        function scalingBpm(heart_rate) {
            if (heart_rate >= 60 && heart_rate <= 100) {
                return(0);
            } else if (heart_rate >= 100 && heart_rate < 110) {
                return (1);
            } else if (heart_rate >= 110 && heart_rate < 120) {
                return (2);
            } else if (heart_rate >= 120 && heart_rate < 140) {
                return (3);
            } else if (heart_rate >= 140 && heart_rate < 160) {
                return (4);
            } else {
                return (5);
            }

        }

        function scalingBodyTemperture(btmp) {

            if (btmp >= 36.5 && btmp <= 37.5) {
                return(0);
            } else if (btmp >= 37.6 && btmp < 38) {
                return(1);
            } else if (btmp >= 38.1 && btmp < 38.5) {
                return(2);
            } else if (btmp >= 38.6 && btmp < 39) {
                return(3);
            } else if (btmp >= 39.1 && btmp < 40) {
                return(4);
            } else {
                return(5);
            }
        }
        function scalingOxygen(oxygen_saturation) {
            if (oxygen_saturation >= 95) {
                return (0);
                
            } else if (oxygen_saturation >= 92 && oxygen_saturation < 95) {
                return (1);
                
            } else if (oxygen_saturation >= 90 && oxygen_saturation < 92) {
                return (2);
                
            } else if (oxygen_saturation >= 85 && oxygen_saturation < 90) {
                return (3);
                
            } else if (oxygen_saturation >= 80 && oxygen_saturation < 85) {
                return (4);
                
            } else {
                return (5);
            }
        }
        function scalingImpulse(impact_force) {
            if (impact_force >= 0 && impact_force < 80) {
                return (0); // negligible impact force
            } else if (impact_force >= 80 && impact_force < 180) {
                return (1); // minor impact force
            } else if (impact_force >= 180 && impact_force < 380) {
                return (2); // moderate impact force
            } else if (impact_force >= 380 && impact_force < 580) {
                return (3); // significant impact force
            } else if (impact_force >= 580 && impact_force < 780) {
                return (4); // severe impact force
            } else {
                return (5); // extremely dangerous impact force
            }
        }
        function scalingAcceleration(acceleration) {
            if (acceleration <= 0) {
                return (0);
            } else if (acceleration <= 2.5) {
                return (1);
            } else if (acceleration <= 5) {
                return (2);
            } else if (acceleration <= 7.5) {
                return (3);
            } else if (acceleration <= 10) {
                return (4);
            } else {
                return (5);
            }

        }

        function scalingCAI(cai) {
            if (cai >= 0 && cai < 50) {
                return (0); 
            } else if (cai >= 50 && cai < 100) {
                return (1); 
            } else if (cai >= 100 && cai < 150) {
                return (2); 
            } else if (cai >= 150 && cai < 200) {
                return (3); 
            } else if (cai >= 250 && cai < 300) {
                return (4); 
            } else {
                return (5); 
            }
        }

        function scalingAmbientTemperture(ambtmp) {
            if (ambtmp >= 15 && ambtmp <= 30) {
                return(0); // normal temperature
            } else if (ambtmp >= 10 && ambtmp < 15) {
                return(1); // slightly abnormal temperature
            } else if ((ambtmp >= 5 && ambtmp < 10) || (ambtmp > 30 && ambtmp <= 35)) {
                return(2); // moderately abnormal temperature
            } else if ((ambtmp >= -5 && ambtmp < 5) || (ambtmp > 35 && ambtmp <= 40)) {
                return(3); // significantly abnormal temperature
            } else if ((ambtmp >= -10 && ambtmp < -5) || (ambtmp > 40 && ambtmp <= 45)) {
                return(4); // dangerously abnormal temperature
            } else {
                return(5); // extreme temperature, potentially fatal
            }
            return (0);
        }

        function scalingAltitude(altitude) {
            if (altitude < 1000) {
                return(0); // normal
            } else if (altitude < 2000) {
                return(1);
            } else if (altitude < 3000) {
                return(2);
            } else if (altitude < 4000) {
                return(3);
            } else if (altitude < 5000) {
                return(4);
            } else {
                return(5); // abnormal and dangerous
            }
        }
        
        function pearsonCorrelation(x, y) {
            if (x.length !== y.length) {
                //throw "same length";
            }

            var n = x.length;

            var sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
            for (var i = 0; i < n; i++) {
                sumX += x[i];
                sumY += y[i];
                sumXY += x[i] * y[i];
                sumX2 += x[i] * x[i];
                sumY2 += y[i] * y[i];
            }

            var numerator = (n * sumXY) - (sumX * sumY);
            var denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));

            return numerator / (denominator + Math.random()/100); // Migaehada
        }
        function calc_index(A, B, C, D, a, b, c) {
            var answer = 0;

            for(var i = 0; i < A.length; i++)
                answer += parseInt(A[i]);
            var AA = answer / A.length;
            answer = 0;
            for(var i = 0; i < B.length; i++)
                answer += parseInt(B[i]);
            var BB = answer / B.length;
            answer = 0;
            for(var i = 0; i < C.length; i++)
                answer += parseInt(C[i]);
            var CC = answer / C.length;
            answer = 0;
            for(var i = 0; i < D.length; i++)
                answer += parseInt(D[i]);
            var DD = answer / D.length;
            
            return Math.sqrt(AA**2 + (a*BB)**2 + (b*CC)**2 + (c*DD)**2);
        }
		function onSubmit() {
            /*
			alert("Values submitted:\n"
				+ "Question 1: " + document.getElementById("q1").value + "\n"
				+ "Question 2: " + document.getElementById("q2").value + "\n"
				+ "Question 3: " + document.getElementById("q3").value + "\n"
				+ "Question 4: " + document.getElementById("q4").value + "\n"
				+ "Question 5: " + document.getElementById("q5").value + "\n"
				+ "Question 6: " + document.getElementById("q6").value + "\n"
				+ "Question 7: " + document.getElementById("q7").value + "\n"
				+ "Question 8: " + document.getElementById("q8").value);
*/
                var q1_b = parseInt(document.getElementById("q1").value); //심박수 40~120 6/1
                var q2_b = parseInt(document.getElementById("q2").value); //온도  
                var q3_b = parseInt(document.getElementById("q3").value); //산소포화도 < 95, >95
                var q4_b = parseInt(document.getElementById("q4").value); 
                var q5_b = parseInt(document.getElementById("q5").value);
                var q6_b = parseInt(document.getElementById("q6").value);
                var q7_b = parseInt(document.getElementById("q7").value);
                var q8_b = parseInt(document.getElementById("q8").value);
                
                var q1 = scalingBpm(q1_b);
                var q2 = scalingBodyTemperture(q2_b);
                var q3 = scalingOxygen(q3_b);
                var q4 = scalingImpulse(q4_b);
                var q5 = scalingAcceleration(q5_b);
                var q6 = scalingCAI(q6_b);
                var q7 = scalingAmbientTemperture(q7_b);
                var q8 = scalingAltitude(q8_b);
                
                console.log(q1_b,q2_b,q3_b,q4_b,q5_b,q6_b,q7_b,q8_b);
                console.log(q1,q2,q3,q4,q5,q6,q7,q8);


                var A = [q1, q2, q3];
                var B = [2, 3, 4];
                var C = [q4, q5, 3];
                var D = [q6, q7, q8];


                var a = pearsonCorrelation(A, D);
                var b = pearsonCorrelation(A, B);
                var c = pearsonCorrelation(A, C);
                var d = pearsonCorrelation(B, D);
                var e = pearsonCorrelation(B, C);
                var f = pearsonCorrelation(C, D);
                //생체-환경
                //생체-사물
                //사물-환경
                var newA = calc_index(A, D, B, C, a, b, c);
                var newB = calc_index(B, A, D, C, b, d, e);
                var newC = calc_index(C, B, C, D, c, e, f);
                var newD = calc_index(D, A, D, B, a, d, f);

                var temp;
                if (Math.max(newA, newB, newC, newD) > 10)
                    temp = 10;
                else
                    temp = (newA+newB+newC+newD) / 4;
                temp = 10 - temp;
                document.getElementById("survey").innerHTML= "";
                document.getElementById("result").style.display = "block";
                document.getElementById("label1").innerText = "생체-환경 상관계수 : " + a;
                document.getElementById("label2").innerText = "생체-사물손상 상관계수 : " + c;
                document.getElementById("label3").innerText = "사물손상-환경 상관계수 : " + f;
                document.getElementById("label4").innerText = "안전지수(0~10) : " + temp;
    

                var ctx1 = document.getElementById("myChart1").getContext("2d");
                var myChart = new Chart(ctx1, {
                    data: {
                            type: "scatter",
                        datasets: [{
                            type: "scatter",
                            label: "(생체) = 환경",
                            data: [{
                                x: A[0],
                                y: D[0]
                            }, {
                                x: A[1],
                                y: D[1]
                            }, {
                                x: A[2],
                                y: D[2]
                            }],
                            pointBackgroundColor: "blue",
                            pointRadius: 8, // Set point size
                        }]
                    },
                    options: {
                        scales: {
                            xAxes: [{
                                title: {
                                    display: true,
                                    text: "생체지표"
                                },
                                type: "linear",
                                position: "bottom",
                                scaleLabel: {
                                    display: true,
                                    labelString: "생체지표"
                                }
                            }],
                            yAxes: [{
                                title: {
                                    display: true,
                                    text: "환경지표"
                                },
                                type: "linear",
                                position: "left",
                                scaleLabel: {
                                    display: true,
                                    labelString: "환경지표"
                                }
                            }]
                        }
                    }
                });
                
                var ctx2 = document.getElementById("myChart2").getContext("2d");
                var myChart = new Chart(ctx2, {
                    data: {
                            type: "scatter",
                        datasets: [{
                            type: "scatter",
                            label: "(생체) = 사물손상",
                            data: [{
                                x: A[0],
                                y: C[0]
                            }, {
                                x: A[1],
                                y: C[1]
                            }, {
                                x: A[2],
                                y: C[2]
                            }],
                            pointBackgroundColor: "blue",
                            pointRadius: 8, // Set point size
                        }]
                    },
                    options: {
                        scales: {
                            xAxes: [{
                                title: {
                                    display: true,
                                    text: "생체지표"
                                },
                                type: "linear",
                                position: "bottom",
                                scaleLabel: {
                                    display: true,
                                    labelString: "생체지표"
                                }
                            }],
                            yAxes: [{
                                title: {
                                    display: true,
                                    text: "사물손상지표"
                                },
                                type: "linear",
                                position: "left",
                                scaleLabel: {
                                    display: true,
                                    labelString: "사물손상지표"
                                }
                            }]
                        }
                    }
                });

                var ctx3 = document.getElementById("myChart3").getContext("2d");
                var myChart = new Chart(ctx3, {
                    data: {
                            type: "scatter",
                        datasets: [{
                            type: "scatter",
                            label: "(사물손상) = 환경",
                            data: [{
                                x: C[0],
                                y: D[0]
                            }, {
                                x: C[1],
                                y: D[1]
                            }, {
                                x: C[2],
                                y: D[2]
                            }],
                            pointBackgroundColor: "blue",
                            pointRadius: 8, // Set point size
                        }]
                    },
                    options: {
                        scales: {
                            xAxes: [{
                                title: {
                                    display: true,
                                    text: "사물손상지표"
                                },
                                type: "linear",
                                position: "bottom",
                                scaleLabel: {
                                    display: true,
                                    labelString: "사물손상지표"
                                }
                            }],
                            yAxes: [{
                                title: {
                                    display: true,
                                    text: "환경지표"
                                },
                                type: "linear",
                                position: "left",
                                scaleLabel: {
                                    display: true,
                                    labelString: "환경지표"
                                }
                            }]
                        }
                    }
                });

                                // Get the canvas element
                const polarChartCanvas = document.getElementById('polarChart');

                // Create a function to update the data for the chart
                function updatePolarChart() {
                  // Get the data for each range from your functions
                  const heartRateData = q1;
                  const bodyTemperatureData = q2;
                  const oxygenSaturationData = q3;
                  const helmetImpactData = q4;
                  const fallAccelerationData = q5;
                  const airPollutionData = q6;
                  const ambientTemperatureData = q7;
                  const altitudeData = q8;

                  // Set the data for the chart
                  polarChart.data.datasets[0].data = [
                    heartRateData,
                    bodyTemperatureData,
                    oxygenSaturationData,
                    helmetImpactData,
                    fallAccelerationData,
                    airPollutionData,
                    ambientTemperatureData,
                    altitudeData
                  ];

                  // Update the chart
                  polarChart.update();
                  
                }
                
                // Define the chart data and options
                const polarData = {
                  labels: ['Heart Rate', 'Body Temperature', 'Oxygen Saturation', 'Helmet Impact', 'Fall Acceleration', 'Strain Gauge Value', 'Air Pollution', 'Ambient Temperature', 'Altitude'],
                  datasets: [{
                    data: [q1, q2, q3, q4, q5, q6, q7, q8],
                    backgroundColor: ['#FF4136', '#FF6347', '#FF7F50', '#FFA07A', '#FFC0CB', '#DC143C', '#2ECC40', '#3D9970', '#32CD32', '#00FF00', '#ADFF2F', '#228B22', '#0074D9', '#7FDBFF', '#39CCCC', '#85144b', '#F012BE', '#B10DC9']
                  }]
                };

                const polarChartOptions = {
                  title: {
                    display: true,
                    text: 'Polar Area Chart'
                  },
                  scale: {
                    ticks: {
                      beginAtZero: true,
                      max: 5
                    }
                  }
                };

                // Create the chart
                const polarChart = new Chart(polarChartCanvas, {
                  type: 'polarArea',
                  data: polarData,
                  options: polarChartOptions
                });

                // Call the updatePolarChart function to update the chart with new data every 5 seconds
                setInterval(updatePolarChart, 1000);
    }
	</script>
</head>
<body>
	<div style="text-align:center;">
		<h1>CRC과제 안전지수 계산</h1>
        <div id="survey">
            <p style="font-weight: bold;"> 이 페이지는 CRC과제에 대한 연구 목적으로 작성 되었으며, 웨어러블 기기의 측정 값을 토대로 안전지수를 산출하기 위한 과정을 보여줍니다. </br>
                질문 내용은 측정 가능한 데이터를 임의로 선정한 것이며, 실제와 상이할 수 있습니다. </br>
                작성한 임의의 센서 측정 값을 토대로 안전지수 산출 공식에 의해 안전지수(0~10)를 도출합니다. </br>
                4가지 지표(생체, 심리, 사물손상, 환경) 중 심리 지표는 고려되지 않았습니다. </br>
                작성한 데이터는 어디에도 저장되지 않습니다.  </br>
            </p>
            <hr class="hr">
        </br>
            <form>
                <label style="font-weight: bold;">생존신호정보 중 생체지표에 관련된 항목입니다.</label>            </br>
                <label for="q1">현재 심박수(bpm)</label>
                <input type="number" id="q1" required/>

                <label for="q2">현재 체온(°C)</label>
                <input type="number" id="q2"required/>

                <label for="q3">산소포화도 센서의 값(%)</label>
                <input type="number" id="q3" required/>
            </br>            </br>
                <label style="font-weight: bold;">생존신호정보 중 사물손상지표에 관련된 항목입니다.</label>            </br>
                <label for="q4">안전모에 가해진 충격량(N)</label>
                <input type="number" id="q4" required/>

                <label for="q5">낙상 감지 시 가속도계 측정 값(m/s²)</label>
                <input type="number" id="q5" required/>
            </br>            </br>
                <label style="font-weight: bold;">생존신호정보 중 환경지표에 관련된 항목입니다.</label>            </br>
                <label for="q6">공기오염도(CAI)</label>
                <input type="number" id="q6" required/>

                <label for="q7">현재 온도(°C)</label>
                <input type="number" id="q7" required/>

                <label for="q8">현재 고도(m)</label>
                <input type="number" id="q8" required/>
            </br>
                <button type="submit" onclick="onSubmit()">Submit</button>
            </form>

        </div>
        <div id="result" style="display:none">
            <img width="400" src="https://i.imgur.com/95FzMrL.png"></br>
        
        </br></br>
        <div class="container1">
            <div class="item">
                <canvas id="myChart1" width="350" height="250" ></canvas>
            </br><strong id="label1"></strong>
            </div>
            <div class="item">
                <canvas id="myChart2" width="350" height="250" ></canvas>
            </br><strong id="label2"></strong>
            </div>
            <div class="item">
                <canvas id="myChart3"  width="350" height="250"></canvas>
            </br><strong id="label3"></strong>
            </div>
        </div>
    </br>
        <div class="container2">
          <canvas id="polarChart"  width="500" height="500"></canvas>
            </div>
        </div>
        
        </br><strong id="label4"></strong>
            
	</div>
</body>
</html>
